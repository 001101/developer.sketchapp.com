---
name: text-utilities
title: text-utilities.js
---
  <div id="container">
    
    <ul class="sections">
      
      <li id="title">
        <div class="annotation"><h1>text-utilities.js</h1></div>
      </li>
      
      
      
      <li id="section-1">
        <div class="annotation">
          
          <div class="pilwrap ">
            <a class="pilcrow" href="#section-1">&#182;</a>
          </div>
          <p>Text Utilities, by Johnnie Walker — Source code available at <a href="https://github.com/BohemianCoding/plugins.examples.text-utilities">GitHub</a></p>
<p>This plugin illustrates a few techniques:</p>
<ul>
<li>iterating over the selected layers</li>
<li>analysing the text layout (in great detail!)</li>
<li>creating new layers</li>
<li>defining multiple commands in a single plugin</li>
</ul>
<h2 id="layout-of-the-plugin">Layout Of The Plugin</h2>
<p>The first thing to do when making a Plugin is to setup the folder structure, which should
look something like this:</p>
<pre><code>   MyPlugin.sketchplugin/
     Contents/
       Sketch/
         manifest.json
         script.js
       Resources/
         a-resource.png
         other-resource.txt
</code></pre><p>For a Plugin with bundled resources, you want to add a <code>Resources</code> folder as well
as the normal <code>Sketch</code> folder, and you want to drop into it any resources that your
script needs to access. These can be files of any type (but obviously keep in mind
that they contribute to the overall size of the Plugin, so your users won’t thank
you if you put too much stuff in there).</p>
<h2 id="manifest">Manifest</h2>
<p>The Plugin needs a <code>manifest.json</code> file. This tells Sketch which menu items your Plugin supplies,
as well as giving some general information about the Plugin such as its name, author, and so on.</p>
<p>As this Plugin illustrates, we can supply multiple menu items, and each one can execute a different command.</p>
<pre><code class="lang-json">{
  <span class="hljs-attr">"author"</span> : <span class="hljs-string">"Johnnie Walker"</span>,
  <span class="hljs-attr">"commands"</span> : [
    {
      <span class="hljs-attr">"script"</span> : <span class="hljs-string">"text-utilities.js"</span>,
      <span class="hljs-attr">"handler"</span> : <span class="hljs-string">"onAddBoth"</span>,
      <span class="hljs-attr">"name"</span> : <span class="hljs-string">"Add Line Fragments &amp; Baselines"</span>,
      <span class="hljs-attr">"identifier"</span> : <span class="hljs-string">"fragmentsandbaselines"</span>
    },
    {
      <span class="hljs-attr">"script"</span> : <span class="hljs-string">"text-utilities.js"</span>,
      <span class="hljs-attr">"handler"</span> : <span class="hljs-string">"onAddBaselines"</span>,
      <span class="hljs-attr">"name"</span> : <span class="hljs-string">"Add Baselines"</span>,
      <span class="hljs-attr">"identifier"</span> : <span class="hljs-string">"baselines"</span>
    },
    {
      <span class="hljs-attr">"script"</span> : <span class="hljs-string">"text-utilities.js"</span>,
      <span class="hljs-attr">"handler"</span> : <span class="hljs-string">"onAddLineFragments"</span>,
      <span class="hljs-attr">"name"</span> : <span class="hljs-string">"Add Line Fragments"</span>,
      <span class="hljs-attr">"identifier"</span> : <span class="hljs-string">"fragments"</span>
    },
    {
      <span class="hljs-attr">"script"</span> : <span class="hljs-string">"text-utilities.js"</span>,
      <span class="hljs-attr">"handler"</span> : <span class="hljs-string">"onUseLegacyBaselines"</span>,
      <span class="hljs-attr">"name"</span> : <span class="hljs-string">"Use legacy typesetter"</span>,
      <span class="hljs-attr">"identifier"</span> : <span class="hljs-string">"legacyTypesetter"</span>
    },
    {
      <span class="hljs-attr">"script"</span> : <span class="hljs-string">"text-utilities.js"</span>,
      <span class="hljs-attr">"handler"</span> : <span class="hljs-string">"onUseConstantBaselines"</span>,
      <span class="hljs-attr">"name"</span> : <span class="hljs-string">"Use constant baselines typesetter"</span>,
      <span class="hljs-attr">"identifier"</span> : <span class="hljs-string">"constantBaselinesTypesetter"</span>
    },
  ],
  <span class="hljs-attr">"menu"</span>: {
    <span class="hljs-attr">"items"</span>: [
      <span class="hljs-string">"baselines"</span>,
      <span class="hljs-string">"fragments"</span>,
      <span class="hljs-string">"fragmentsandbaselines"</span>,
      <span class="hljs-string">"-"</span>,
      <span class="hljs-string">"legacyTypesetter"</span>,
      <span class="hljs-string">"constantBaselinesTypesetter"</span>,
    ],
  },
  <span class="hljs-attr">"identifier"</span> : <span class="hljs-string">"com.sketchapp.examples.text-utilities"</span>,
  <span class="hljs-attr">"version"</span> : <span class="hljs-string">"2.0"</span>,
  <span class="hljs-attr">"description"</span> : <span class="hljs-string">"Utilities for text layers"</span>,
  <span class="hljs-attr">"authorEmail"</span> : <span class="hljs-string">"developer@sketchapp.com"</span>,
  <span class="hljs-attr">"name"</span> : <span class="hljs-string">"Text Layer Utilities"</span>
}
</code></pre>

        </div>
        
      </li>
      
      
      <li id="section-2">
        <div class="annotation">
          
          <div class="pilwrap ">
            <a class="pilcrow" href="#section-2">&#182;</a>
          </div>
          <h2 id="code">Code</h2>

        </div>
        
      </li>
      
      
      <li id="section-3">
        <div class="annotation">
          
          <div class="pilwrap ">
            <a class="pilcrow" href="#section-3">&#182;</a>
          </div>
          <h3 id="some-utilities">Some Utilities</h3>
<p>First up, we want to define a few utility functions to help us in implementing the plugin commands.</p>
<p>The first of these takes a container, a list of line fragments, and an action function which it applies to each fragment.</p>

        </div>
        
        <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processFragments</span>(<span class="hljs-params">sketch, container, fragments, action</span>) </span>{</pre></div></div>
        
      </li>
      
      
      <li id="section-4">
        <div class="annotation">
          
          <div class="pilwrap ">
            <a class="pilcrow" href="#section-4">&#182;</a>
          </div>
          <p>First move the container to the back of the document.</p>

        </div>
        
        <div class="content"><div class='highlight'><pre>    container.moveToBack()</pre></div></div>
        
      </li>
      
      
      <li id="section-5">
        <div class="annotation">
          
          <div class="pilwrap ">
            <a class="pilcrow" href="#section-5">&#182;</a>
          </div>
          <p>Iterate through each fragment, executing the action.</p>

        </div>
        
        <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> fragments) {
      action(sketch, container, fragments[i], i)
    }</pre></div></div>
        
      </li>
      
      
      <li id="section-6">
        <div class="annotation">
          
          <div class="pilwrap ">
            <a class="pilcrow" href="#section-6">&#182;</a>
          </div>
          <p>Adjust the container to enclose any new layers we’ve placed in it.</p>

        </div>
        
        <div class="content"><div class='highlight'><pre>    container.adjustToFit()
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addBaselines</span>(<span class="hljs-params">sketch, layer, fragments</span>) </span>{
    <span class="hljs-keyword">var</span> container = layer.container.newGroup({<span class="hljs-string">"name"</span> : <span class="hljs-string">"Baselines"</span>})
    processFragments(sketch, container, fragments, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sketch, group, fragment, index</span>) </span>{
        <span class="hljs-keyword">var</span> rect = layer.localRectToParentRect(fragment.rect)
        rect.y += rect.height - fragment.baselineOffset
        rect.height = <span class="hljs-number">0.5</span>
        group.newShape({<span class="hljs-string">"frame"</span>: rect, fills: [<span class="hljs-string">"#ff000090"</span>], borders: []})
    })
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addLineFragments</span>(<span class="hljs-params">sketch, layer, fragments</span>) </span>{
    <span class="hljs-keyword">var</span> container = layer.container.newGroup({<span class="hljs-string">"name"</span> : <span class="hljs-string">"Line Fragments"</span>})
    processFragments(sketch, container, fragments, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">sketch, group, fragment, index</span>) </span>{
        <span class="hljs-keyword">var</span> color = ( index &amp; <span class="hljs-number">1</span> ) ? <span class="hljs-string">"#00ff00ff"</span> : <span class="hljs-string">"#00fff0044"</span>
        <span class="hljs-keyword">var</span> localRect = layer.localRectToParentRect(fragment.rect)
        <span class="hljs-keyword">var</span> line = group.newShape({<span class="hljs-string">"frame"</span>: localRect, fills: [color], borders: []})
    })
}</pre></div></div>
        
      </li>
      
      
      <li id="section-7">
        <div class="annotation">
          
          <div class="pilwrap ">
            <a class="pilcrow" href="#section-7">&#182;</a>
          </div>
          <h3 id="defining-the-run-handler">Defining The Run Handler</h3>

        </div>
        
      </li>
      
      
      <li id="section-8">
        <div class="annotation">
          
          <div class="pilwrap ">
            <a class="pilcrow" href="#section-8">&#182;</a>
          </div>
          <p>In the manifest, we told Sketch that every time the “Bundled Resources Example” menu is selected,
we want to execute a javascript handler called <code>onRun</code> in the <code>resources.js</code> file.</p>

        </div>
        
      </li>
      
      
      <li id="section-9">
        <div class="annotation">
          
          <div class="pilwrap ">
            <a class="pilcrow" href="#section-9">&#182;</a>
          </div>
          <p>So now we need to put some code into the <code>resources.js</code> file to implement that command.</p>

        </div>
        
        <div class="content"><div class='highlight'><pre>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onAddLineFragments</span>(<span class="hljs-params">context</span>) </span>{
    <span class="hljs-keyword">var</span> sketch = context.api()
    sketch.selectedDocument.selectedLayers.iterateWithFilter(<span class="hljs-string">"isText"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">layer</span>) </span>{
        addLineFragments(sketch, layer, layer.fragments)
    })
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onAddBaselines</span>(<span class="hljs-params">context</span>) </span>{
    <span class="hljs-keyword">var</span> sketch = context.api()
    sketch.selectedDocument.selectedLayers.iterateWithFilter(<span class="hljs-string">"isText"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">layer</span>) </span>{
        addBaselines(sketch, layer, layer.fragments)
    })
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onAddBoth</span>(<span class="hljs-params">context</span>) </span>{
    <span class="hljs-keyword">var</span> sketch = context.api()
    sketch.selectedDocument.selectedLayers.iterateWithFilter(<span class="hljs-string">"isText"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">layer</span>) </span>{
        <span class="hljs-keyword">var</span> lineFragments = layer.fragments
        addBaselines(sketch, layer, lineFragments)
        addLineFragments(sketch, layer, lineFragments)
    })
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onUseLegacyBaselines</span>(<span class="hljs-params">context</span>) </span>{
  <span class="hljs-keyword">var</span> sketch = context.api()
  sketch.selectedDocument.selectedLayers.iterateWithFilter(<span class="hljs-string">"isText"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">layer</span>) </span>{
    layer.useConstantBaselines = <span class="hljs-literal">false</span>
  })
}


<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onUseConstantBaselines</span>(<span class="hljs-params">context</span>) </span>{
  <span class="hljs-keyword">var</span> sketch = context.api()
  sketch.selectedDocument.selectedLayers.iterateWithFilter(<span class="hljs-string">"isText"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">layer</span>) </span>{
    layer.useConstantBaselines = <span class="hljs-literal">true</span>
  })
}</pre></div></div>
        
      </li>
      
    </ul>
  </div>
